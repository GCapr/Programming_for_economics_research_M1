<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>5B.3 Randomization | ProTools ER1</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=Fira+Code:wght@400;500&family=Source+Sans+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .protected-content { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
    .code-tooltip { position: relative; cursor: help; border-bottom: 1px dotted #888; text-decoration: none; }
    .tooltip-popup { position: fixed; background: #1f2937; color: white; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.75rem; white-space: normal; max-width: 300px; opacity: 0; pointer-events: none; transition: opacity 0.15s ease-in-out; z-index: 10000; }
    .tooltip-popup.visible { opacity: 1; }
  </style>
</head>
<body>
  <div id="password-overlay" class="password-overlay">
    <div class="password-modal">
      <h2>ProTools ER1</h2>
      <p>Programming Tools for Empirical Research</p>
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">Please enter the course password to access the materials.</p>
      <input type="password" id="password-input" placeholder="Enter password" autocomplete="off">
      <button id="password-submit">Access Course</button>
      <p id="password-error" style="color: #e53e3e; font-size: 0.85rem; margin-top: 1rem; display: none;">Incorrect password. Please try again.</p>
    </div>
  </div>

  <div class="page-wrapper protected-content">
    <aside class="sidebar">
      <a href="../index.html" class="sidebar-logo">ProTools ER1</a>
      <span class="sidebar-subtitle">Programming Tools for Empirical Research</span>
      <nav>
        <ul>
          <li><a href="../index.html"><span class="welcome-icon">üè†</span> Welcome</a></li>
          <li><a href="05-data-analysis.html"><span class="module-number">5</span> Data Analysis</a></li>
          <li><a href="05a-data-simulation.html"><span class="module-number">5A</span> Data Simulation</a></li>
          <li>
            <a href="05b-experiments.html"><span class="module-number">5B</span> Coding for Experiments</a>
            <ul class="sub-nav">
              <li><a href="05b1-power-analysis.html">Power Analysis</a></li>
              <li><a href="05b2-survey-programming.html">Survey Programming</a></li>
              <li class="active"><a href="05b3-randomization.html">Randomization</a></li>
              <li><a href="05b4-balance-checks.html">Balance Checks</a></li>
            </ul>
          </li>
          <li><a href="06-causal-inference.html"><span class="module-number">6</span> Causal Inference</a></li>
          <li><a href="07-estimation.html"><span class="module-number">7</span> Estimation Methods</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <div class="content">
        <nav class="breadcrumb" style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
          <a href="05b-experiments.html">5B Experiments</a> &raquo; Randomization
        </nav>

        <div class="module-header">
          <h1>5B.3 &nbsp;Randomization</h1>
          <div class="module-meta">
            <span>~2 hours</span>
            <span>Simple, Stratified, Cluster</span>
          </div>
        </div>

        <div class="toc">
          <h3>Table of Contents</h3>
          <ul>
            <li><a href="#simple">Simple Random Assignment</a></li>
            <li><a href="#stratified">Stratified Randomization</a></li>
            <li><a href="#cluster">Cluster Randomization</a></li>
            <li><a href="#verification">Verification and Documentation</a></li>
          </ul>
        </div>

        <h2 id="simple">Simple Random Assignment</h2>

        <p>
          Each unit has equal probability of assignment to treatment or control, independent of other units.
        </p>

        <div class="code-tabs">
          <div class="tab-buttons">
            <button class="tab-button active" data-lang="python">Python</button>
            <button class="tab-button" data-lang="stata">Stata</button>
            <button class="tab-button" data-lang="r">R</button>
          </div>
          <div class="tab-content active" data-lang="python">
<pre><code><span class="code-comment"># Python: Simple random assignment</span>
<span class="code-keyword">import</span> numpy <span class="code-keyword">as</span> np
<span class="code-keyword">import</span> pandas <span class="code-keyword">as</span> pd

np.random.seed(42)  <span class="code-comment"># Always set seed for reproducibility!</span>

<span class="code-comment"># Method 1: Bernoulli (coin flip for each)</span>
df[<span class="code-string">'treatment'</span>] = np.random.binomial(1, 0.5, len(df))

<span class="code-comment"># Method 2: Complete randomization (fixed number treated)</span>
n = len(df)
n_treat = n // 2
<span class="code-tooltip" data-tip="Creates exactly n_treat 1s and the rest 0s, then shuffles">assignment = np.array([1] * n_treat + [0] * (n - n_treat))
np.random.shuffle(assignment)</span>
df[<span class="code-string">'treatment'</span>] = assignment</code></pre>
          </div>
          <div class="tab-content" data-lang="stata">
<pre><code><span class="code-comment">* Stata: Simple random assignment</span>
set seed 42

<span class="code-comment">* Method 1: Bernoulli</span>
gen treatment = rbinomial(1, 0.5)

<span class="code-comment">* Method 2: Complete randomization (exact proportions)</span>
<span class="code-tooltip" data-tip="randtreat is a community-contributed command - install with: ssc install randtreat">randtreat, generate(treatment) setseed(42)</span>

<span class="code-comment">* Multiple treatment arms</span>
randtreat, generate(treatment) mult(3) setseed(42)
<span class="code-comment">* Creates treatment = 1, 2, or 3 with equal probability</span></code></pre>
          </div>
          <div class="tab-content" data-lang="r">
<pre><code><span class="code-comment"># R: Simple random assignment with randomizr</span>
<span class="code-keyword">library</span>(randomizr)

set.seed(42)

<span class="code-comment"># Simple random assignment</span>
<span class="code-tooltip" data-tip="simple_ra() does Bernoulli randomization">df$treatment <- simple_ra(N = nrow(df))</span>

<span class="code-comment"># Complete random assignment (fixed number treated)</span>
<span class="code-tooltip" data-tip="complete_ra() ensures exact treatment proportions">df$treatment <- complete_ra(N = nrow(df), prob = 0.5)</span>

<span class="code-comment"># Multiple treatment arms</span>
df$treatment <- complete_ra(N = nrow(df), num_arms = 3)</code></pre>
          </div>
        </div>

        <h2 id="stratified">Stratified Randomization</h2>

        <p>
          Randomize within subgroups (strata) defined by covariates. Ensures balance on key variables.
        </p>

        <div class="code-tabs">
          <div class="tab-buttons">
            <button class="tab-button active" data-lang="python">Python</button>
            <button class="tab-button" data-lang="stata">Stata</button>
            <button class="tab-button" data-lang="r">R</button>
          </div>
          <div class="tab-content active" data-lang="python">
<pre><code><span class="code-comment"># Python: Stratified randomization</span>
<span class="code-keyword">import</span> numpy <span class="code-keyword">as</span> np
<span class="code-keyword">import</span> pandas <span class="code-keyword">as</span> pd

np.random.seed(42)

<span class="code-keyword">def</span> <span class="code-function">stratified_randomize</span>(df, strata_cols, prob_treat=0.5):
    <span class="code-string">"""Randomize within strata defined by strata_cols."""</span>
    df = df.copy()
    df[<span class="code-string">'treatment'</span>] = np.nan

    <span class="code-tooltip" data-tip="Randomize separately within each stratum">for name, group <span class="code-keyword">in</span> df.groupby(strata_cols):
        n = len(group)
        n_treat = int(n * prob_treat)
        assignment = [1] * n_treat + [0] * (n - n_treat)
        np.random.shuffle(assignment)
        df.loc[group.index, <span class="code-string">'treatment'</span>] = assignment</span>

    <span class="code-keyword">return</span> df

<span class="code-comment"># Stratify by gender and age group</span>
df = stratified_randomize(df, strata_cols=[<span class="code-string">'gender'</span>, <span class="code-string">'age_group'</span>])</code></pre>
          </div>
          <div class="tab-content" data-lang="stata">
<pre><code><span class="code-comment">* Stata: Stratified randomization with randtreat</span>
set seed 42

<span class="code-comment">* Stratify by gender and region</span>
<span class="code-tooltip" data-tip="strata() option ensures randomization happens within each combination of stratifying variables">randtreat, generate(treatment) strata(gender region) setseed(42)</span>

<span class="code-comment">* With unequal treatment probabilities</span>
randtreat, generate(treatment) strata(gender) ///
    misfits(global) setseed(42) frac(0.25 0.25 0.5)</code></pre>
          </div>
          <div class="tab-content" data-lang="r">
<pre><code><span class="code-comment"># R: Stratified randomization with randomizr</span>
<span class="code-keyword">library</span>(randomizr)

set.seed(42)

<span class="code-comment"># Block random assignment (stratified)</span>
<span class="code-tooltip" data-tip="block_ra() randomizes within blocks/strata. Pass the blocking variable.">df$treatment <- block_ra(
  blocks = df$gender,
  prob = 0.5
)</span>

<span class="code-comment"># Multiple blocking variables</span>
df$strata <- interaction(df$gender, df$region)
df$treatment <- block_ra(blocks = df$strata)</code></pre>
          </div>
        </div>

        <h2 id="cluster">Cluster Randomization</h2>

        <p>
          When treatment must be applied at the group level (classrooms, villages, firms), randomize clusters rather than individuals.
        </p>

        <div class="code-tabs">
          <div class="tab-buttons">
            <button class="tab-button active" data-lang="python">Python</button>
            <button class="tab-button" data-lang="stata">Stata</button>
            <button class="tab-button" data-lang="r">R</button>
          </div>
          <div class="tab-content active" data-lang="python">
<pre><code><span class="code-comment"># Python: Cluster randomization</span>
<span class="code-keyword">import</span> numpy <span class="code-keyword">as</span> np
<span class="code-keyword">import</span> pandas <span class="code-keyword">as</span> pd

np.random.seed(42)

<span class="code-comment"># Get unique clusters</span>
clusters = df[<span class="code-string">'cluster_id'</span>].unique()
n_clusters = len(clusters)

<span class="code-comment"># Randomize at cluster level</span>
<span class="code-tooltip" data-tip="Assign treatment to clusters, not individuals">cluster_treatment = dict(zip(
    clusters,
    np.random.binomial(1, 0.5, n_clusters)
))</span>

<span class="code-comment"># Map back to individuals</span>
df[<span class="code-string">'treatment'</span>] = df[<span class="code-string">'cluster_id'</span>].map(cluster_treatment)</code></pre>
          </div>
          <div class="tab-content" data-lang="stata">
<pre><code><span class="code-comment">* Stata: Cluster randomization</span>
set seed 42

<span class="code-comment">* Randomize at cluster level</span>
<span class="code-tooltip" data-tip="cluster() option assigns all units in a cluster to the same treatment">randtreat, generate(treatment) cluster(school_id) setseed(42)</span>

<span class="code-comment">* Stratified cluster randomization</span>
randtreat, generate(treatment) cluster(school_id) ///
    strata(district) setseed(42)</code></pre>
          </div>
          <div class="tab-content" data-lang="r">
<pre><code><span class="code-comment"># R: Cluster randomization with randomizr</span>
<span class="code-keyword">library</span>(randomizr)

set.seed(42)

<span class="code-comment"># Cluster random assignment</span>
<span class="code-tooltip" data-tip="cluster_ra() assigns all units in a cluster to the same treatment">df$treatment <- cluster_ra(
  clusters = df$school_id,
  prob = 0.5
)</span>

<span class="code-comment"># Stratified cluster randomization</span>
df$treatment <- block_and_cluster_ra(
  blocks = df$district,
  clusters = df$school_id
)</code></pre>
          </div>
        </div>

        <h2 id="verification">Verification and Documentation</h2>

        <p>
          Always verify your randomization worked correctly:
        </p>

        <ol>
          <li><strong>Check proportions:</strong> Are treatment groups the expected sizes?</li>
          <li><strong>Check balance:</strong> Are covariates balanced? (See <a href="05b4-balance-checks.html">next section</a>)</li>
          <li><strong>Document seed:</strong> Record the random seed for reproducibility</li>
          <li><strong>Save assignment:</strong> Export the treatment assignment file before launching</li>
        </ol>

        <div class="info-box warning">
          <div class="info-box-title">Critical: Document Everything</div>
          <p style="margin-bottom: 0;">
            Save your randomization script, the seed, and the treatment assignment file. In your pre-analysis plan, specify your randomization procedure exactly. You should be able to reproduce the exact same treatment assignment from the same seed.
          </p>
        </div>

        <div class="nav-footer">
          <a href="05b2-survey-programming.html" class="nav-link prev">5B.2: Survey Programming</a>
          <a href="05b4-balance-checks.html" class="nav-link next">5B.4: Balance Checks</a>
        </div>
      </div>
    </main>
  </div>

  <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">Menu</button>
  <script src="../js/main.js"></script>
  <script src="../js/password-protection.js"></script>
</body>
</html>
